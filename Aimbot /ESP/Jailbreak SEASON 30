-- AIM JAILBREAK | AIMLOCK POLICE ONLY + ESP POLICE (ECLIPSE GUI FINAL)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera

local LP = Players.LocalPlayer

-- ================= SETTINGS =================
local AIM_ON = false
local ESP_ON = false

local AIM_KEY = Enum.KeyCode.X
local ESP_KEY = Enum.KeyCode.N
local GUI_KEY = Enum.KeyCode.RightShift

local ESP_RANGE = 3200
local PREDICTION = 0.08

local lockedPlayer = nil
local GUI_VISIBLE = true
local waitingForKey = false

-- PANEL STATE
local PANEL_VISIBLE = false
local PANEL_TWEENING = false

-- ================= POLICE CHECK =================
local function isPolice(p)
	return p ~= LP and p.Team and p.Team.Name == "Police"
end

-- ================= AIM TARGET =================
local function getNearestPolice()
	local mousePos = UserInputService:GetMouseLocation()
	local nearest, shortest

	for _,p in ipairs(Players:GetPlayers()) do
		if isPolice(p)
			and p.Character
			and p.Character:FindFirstChild("Head")
			and p.Character:FindFirstChild("HumanoidRootPart")
			and p.Character:FindFirstChild("Humanoid")
			and p.Character.Humanoid.Health > 0 then

			local pos, onscreen = Camera:WorldToViewportPoint(p.Character.Head.Position)
			if onscreen then
				local dist = (Vector2.new(pos.X,pos.Y) - mousePos).Magnitude
				if not shortest or dist < shortest then
					shortest = dist
					nearest = p
				end
			end
		end
	end
	return nearest
end

-- ================= INPUT =================
UserInputService.InputBegan:Connect(function(i,gp)
	if gp then return end

	if waitingForKey and i.UserInputType == Enum.UserInputType.Keyboard then
		GUI_KEY = i.KeyCode
		waitingForKey = false
		return
	end

	if i.KeyCode == AIM_KEY then
		if not AIM_ON then
			lockedPlayer = getNearestPolice()
		end
		AIM_ON = not AIM_ON
	end

	if i.KeyCode == ESP_KEY then
		ESP_ON = not ESP_ON
	end

	if i.KeyCode == GUI_KEY then
		GUI_VISIBLE = not GUI_VISIBLE
		if GUI_VISIBLE then
			showPanel()
		else
			hidePanel()
		end
	end
end)

-- ================= AIM =================
RunService.RenderStepped:Connect(function()
	if AIM_ON and lockedPlayer and lockedPlayer.Character then
		local h = lockedPlayer.Character:FindFirstChild("Head")
		local hrp = lockedPlayer.Character:FindFirstChild("HumanoidRootPart")
		local hum = lockedPlayer.Character:FindFirstChild("Humanoid")

		if h and hrp and hum and hum.Health > 0 and isPolice(lockedPlayer) then
			local aimPos = h.Position + hrp.Velocity * PREDICTION
			Camera.CFrame = CFrame.new(Camera.CFrame.Position, aimPos)
		end
	end
end)

-- ================= ESP SYSTEM =================
local ESP_CACHE = {}

local function removeESP(p)
	if ESP_CACHE[p] then
		ESP_CACHE[p]:Destroy()
		ESP_CACHE[p] = nil
	end
end

local function applyESP(p)
	if not ESP_ON then return end
	if not isPolice(p) then return end
	if not p.Character then return end
	if ESP_CACHE[p] then return end

	local hum = p.Character:FindFirstChild("Humanoid")
	local hrp = p.Character:FindFirstChild("HumanoidRootPart")
	if not hum or not hrp then return end

	local bill = Instance.new("BillboardGui")
	bill.Name = "PoliceESP"
	bill.Size = UDim2.new(0,320,0,30)
	bill.AlwaysOnTop = true
	bill.Adornee = hrp
	bill.Parent = game.CoreGui

	local txt = Instance.new("TextLabel", bill)
	txt.Size = UDim2.new(1,0,1,0)
	txt.BackgroundTransparency = 1
	txt.TextStrokeTransparency = 0
	txt.Font = Enum.Font.GothamBold
	txt.TextSize = 14
	txt.TextXAlignment = Enum.TextXAlignment.Center
	txt.TextYAlignment = Enum.TextYAlignment.Center

	RunService.RenderStepped:Connect(function()
		if not ESP_ON or not p.Character or hum.Health <= 0 then
			removeESP(p)
			return
		end

		local myHRP = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
		if not myHRP then return end

		local dist = (myHRP.Position - hrp.Position).Magnitude
		if dist > ESP_RANGE then
			bill.Enabled = false
			return
		else
			bill.Enabled = true
		end

		-- ĐỔI MÀU THEO KHOẢNG CÁCH (XA = XANH | GẦN = ĐỎ)
		local ratio = math.clamp(dist / ESP_RANGE, 0, 1)
		local r = math.floor(255 * (1 - ratio))
		local g = math.floor(255 * ratio)
		txt.TextColor3 = Color3.fromRGB(r, g, 80)

		txt.Text = string.format(
			"[POLICE] %s | HP:%d | %dm",
			p.Name,
			math.floor(hum.Health),
			math.floor(dist)
		)
	end)

	ESP_CACHE[p] = bill
end

local function hookPlayer(p)
	p.CharacterAdded:Connect(function()
		task.wait(0.5)
		applyESP(p)
	end)
end

for _,p in ipairs(Players:GetPlayers()) do
	hookPlayer(p)
end

Players.PlayerAdded:Connect(hookPlayer)
Players.PlayerRemoving:Connect(removeESP)

RunService.RenderStepped:Connect(function()
	if ESP_ON then
		for _,p in ipairs(Players:GetPlayers()) do
			applyESP(p)
		end
	end
end)

-- ================= NOTIFY (ANIMATION FULL) =================
local function notify(txt)
	local g = Instance.new("ScreenGui", game.CoreGui)
	g.IgnoreGuiInset = true

	local f = Instance.new("Frame", g)
	f.Size = UDim2.new(0,260,0,70)
	f.Position = UDim2.new(1,-280,1,-60)
	f.BackgroundColor3 = Color3.fromRGB(35,35,35)
	f.BackgroundTransparency = 1
	Instance.new("UICorner", f)

	local t = Instance.new("TextLabel", f)
	t.Size = UDim2.new(1,0,1,0)
	t.BackgroundTransparency = 1
	t.Text = "Eclipse HUB\n"..txt
	t.Font = Enum.Font.Gotham
	t.TextSize = 14
	t.TextColor3 = Color3.new(1,1,1)
	t.TextTransparency = 1

	TweenService:Create(f,TweenInfo.new(0.35,Enum.EasingStyle.Quart,Enum.EasingDirection.Out),{
		BackgroundTransparency = 0.15,
		Position = UDim2.new(1,-280,1,-90)
	}):Play()

	TweenService:Create(t,TweenInfo.new(0.35),{
		TextTransparency = 0
	}):Play()

	task.delay(5,function()
		TweenService:Create(f,TweenInfo.new(0.25,Enum.EasingStyle.Quad,Enum.EasingDirection.In),{
			BackgroundTransparency = 1,
			Position = UDim2.new(1,-280,1,-60)
		}):Play()

		TweenService:Create(t,TweenInfo.new(0.25),{
			TextTransparency = 1
		}):Play()

		task.delay(0.25,function()
			g:Destroy()
		end)
	end)
end

notify("Please wait 5 seconds...")

-- ================= GUI =================
local gui = Instance.new("ScreenGui",game.CoreGui)
gui.IgnoreGuiInset = true

local board = Instance.new("Frame",gui)
board.Size = UDim2.new(0,340,0,230)
board.Position = UDim2.new(.5,-170,.56,-115)
board.BackgroundColor3 = Color3.fromRGB(30,30,30)
board.BackgroundTransparency = 1
board.BorderSizePixel = 0
board.Visible = false
Instance.new("UICorner",board)

local title = Instance.new("TextLabel",board)
title.Size = UDim2.new(1,0,0,30)
title.Text = "Eclipse HUB"
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextColor3 = Color3.fromRGB(90,180,255)
title.BackgroundTransparency = 1
title.TextTransparency = 1

local aimStatus = Instance.new("TextLabel",board)
aimStatus.Position = UDim2.new(0,0,0,40)
aimStatus.Size = UDim2.new(1,0,0,25)
aimStatus.Font = Enum.Font.Gotham
aimStatus.TextSize = 16
aimStatus.BackgroundTransparency = 1
aimStatus.TextTransparency = 1

local espStatus = Instance.new("TextLabel",board)
espStatus.Position = UDim2.new(0,0,0,70)
espStatus.Size = UDim2.new(1,0,0,25)
espStatus.Font = Enum.Font.Gotham
espStatus.TextSize = 16
espStatus.BackgroundTransparency = 1
espStatus.TextTransparency = 1

local keyBtn = Instance.new("TextButton",board)
keyBtn.Position = UDim2.new(0.1,0,0,110)
keyBtn.Size = UDim2.new(0.8,0,0,30)
keyBtn.BackgroundColor3 = Color3.fromRGB(45,45,45)
keyBtn.TextColor3 = Color3.new(1,1,1)
keyBtn.Font = Enum.Font.Gotham
keyBtn.TextSize = 14
keyBtn.Text = "GUI KEY : "..GUI_KEY.Name:upper()
Instance.new("UICorner",keyBtn)

keyBtn.MouseButton1Click:Connect(function()
	waitingForKey = true
	keyBtn.Text = "PRESS ANY KEY..."
end)

-- ================= PANEL ANIMATION =================
function showPanel()
	if PANEL_TWEENING or PANEL_VISIBLE then return end
	PANEL_TWEENING = true
	PANEL_VISIBLE = true

	board.Visible = true
	board.BackgroundTransparency = 1
	board.Position = UDim2.new(.5,-170,.56,-115)

	TweenService:Create(board,TweenInfo.new(0.35,Enum.EasingStyle.Quart,Enum.EasingDirection.Out),{
		BackgroundTransparency = 0.15,
		Position = UDim2.new(.5,-170,.5,-115)
	}):Play()

	for _,v in ipairs({title,aimStatus,espStatus,keyBtn}) do
		TweenService:Create(v,TweenInfo.new(0.35),{TextTransparency=0}):Play()
	end

	task.delay(0.35,function()
		PANEL_TWEENING = false
	end)
end

function hidePanel()
	if PANEL_TWEENING or not PANEL_VISIBLE then return end
	PANEL_TWEENING = true
	PANEL_VISIBLE = false

	TweenService:Create(board,TweenInfo.new(0.25,Enum.EasingStyle.Quad,Enum.EasingDirection.In),{
		BackgroundTransparency = 1,
		Position = UDim2.new(.5,-170,.56,-115)
	}):Play()

	for _,v in ipairs({title,aimStatus,espStatus,keyBtn}) do
		TweenService:Create(v,TweenInfo.new(0.25),{TextTransparency=1}):Play()
	end

	task.delay(0.25,function()
		board.Visible = false
		PANEL_TWEENING = false
	end)
end

-- ================= GUI UPDATE ONLY =================
RunService.RenderStepped:Connect(function()
	aimStatus.Text = AIM_ON and "AIMLOCK : ON [X]" or "AIMLOCK : OFF [X]"
	aimStatus.TextColor3 = AIM_ON and Color3.fromRGB(80,255,120) or Color3.fromRGB(255,80,80)

	espStatus.Text = ESP_ON and "ESP POLICE : ON [N]" or "ESP POLICE : OFF [N]"
	espStatus.TextColor3 = ESP_ON and Color3.fromRGB(80,255,120) or Color3.fromRGB(255,80,80)

	keyBtn.Text = waitingForKey and "PRESS ANY KEY..."
		or ("GUI KEY : "..GUI_KEY.Name:upper())
end)

-- HIỆN PANEL LẦN ĐẦU CÓ ANIMATION
task.delay(5,function()
	showPanel()
end)
